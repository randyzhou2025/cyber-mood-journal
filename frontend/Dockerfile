# ===== 1. æ„å»ºé˜¶æ®µ =====
FROM node:18-bullseye-slim AS builder

WORKDIR /app

# ğŸ‘‡ æ¥æ”¶ CloudBase æ³¨å…¥çš„ build arg
ARG NEXT_PUBLIC_API_BASE
ENV NEXT_PUBLIC_API_BASE=$NEXT_PUBLIC_API_BASE

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY package.json package-lock.json ./

RUN npm install

# å¤åˆ¶æºç 
COPY . .

# æ„å»º Next.js
RUN npm run build

# ===== 2. è¿è¡Œé˜¶æ®µ =====
FROM node:18-bullseye-slim AS runner

WORKDIR /app

ENV NODE_ENV=production

# åªå¤åˆ¶è¿è¡Œæ‰€éœ€æ–‡ä»¶
COPY --from=builder /app/package.json ./
COPY --from=builder /app/package-lock.json ./
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/.next ./.next
COPY --from=builder /app/next.config.js ./next.config.js

# Next.js è¿è¡Œç«¯å£
EXPOSE 3000

# å¯åŠ¨ Next.js
CMD ["npm", "run", "start"]
